{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/src/lib/payments.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n  return createClient(url, service || anon!);\r\n}\r\n\r\nexport function getUserFromHeader(xRpUser: string | null): any | null {\r\n  if (!xRpUser) return null;\r\n  try {\r\n    return JSON.parse(xRpUser);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function canRecordPayments(user: any) {\r\n  if (!user) return false;\r\n  if (String(user.role || \"\").toLowerCase() === \"admin\") return true;\r\n  // allow accounting / sales to record payments if you have permissions object\r\n  return Boolean(user?.permissions?.canEditInvoices || user?.permissions?.canEditPayments);\r\n}\r\n\r\nexport function canDeletePayments(user: any) {\r\n  if (!user) return false;\r\n  return String(user.role || \"\").toLowerCase() === \"admin\";\r\n}\r\n\r\nfunction n2(v: any) {\r\n  const x = Number(v ?? 0);\r\n  return Number.isFinite(x) ? x : 0;\r\n}\r\n\r\nfunction statusFromPaid(totalDue: number, paid: number, currentStatus: string) {\r\n  const cur = String(currentStatus || \"\").toUpperCase().trim();\r\n  if (cur === \"VOID\") return \"VOID\";\r\n\r\n  const due = Math.max(0, totalDue);\r\n  const p = Math.max(0, paid);\r\n\r\n  if (p <= 0) return \"ISSUED\";\r\n  if (p + 0.00001 >= due) return \"PAID\";\r\n  return \"PARTIALLY_PAID\";\r\n}\r\n\r\n/**\r\n * Recalculate and persist invoice payment state:\r\n * - amount_paid\r\n * - balance_due\r\n * - balance_remaining\r\n * - gross_total\r\n * - status (ISSUED / PARTIALLY_PAID / PAID) unless VOID\r\n *\r\n * Uses:\r\n * - invoices.gross_total if present,\r\n * - else total_amount + previous_balance\r\n */\r\nexport async function recalcInvoicePaymentState(invoiceId: number | string) {\r\n  const supabase = supaAdmin();\r\n\r\n  // 1) get invoice totals + current status\r\n  const { data: inv, error: invErr } = await supabase\r\n    .from(\"invoices\")\r\n    .select(\"id,status,total_amount,previous_balance,gross_total\")\r\n    .eq(\"id\", invoiceId)\r\n    .single();\r\n\r\n  if (invErr) throw new Error(invErr.message);\r\n\r\n  const currentStatus = String(inv?.status || \"\").toUpperCase().trim();\r\n\r\n  const totalAmount = n2(inv?.total_amount);\r\n  const previousBalance = n2(inv?.previous_balance);\r\n\r\n  // Prefer stored gross_total, else compute\r\n  const grossTotal =\r\n    inv?.gross_total != null ? n2(inv.gross_total) : totalAmount + previousBalance;\r\n\r\n  // 2) sum payments\r\n  const { data: pays, error: payErr } = await supabase\r\n    .from(\"invoice_payments\")\r\n    .select(\"amount\")\r\n    .eq(\"invoice_id\", invoiceId);\r\n\r\n  if (payErr) throw new Error(payErr.message);\r\n\r\n  const paid = (pays || []).reduce((sum: number, p: any) => sum + n2(p.amount), 0);\r\n\r\n  const balance = Math.max(0, grossTotal - paid);\r\n\r\n  // 3) compute next status\r\n  const nextStatus = statusFromPaid(grossTotal, paid, currentStatus);\r\n\r\n  // 4) update invoice\r\n  const { error: upErr } = await supabase\r\n    .from(\"invoices\")\r\n    .update({\r\n      amount_paid: paid,\r\n      balance_due: balance,\r\n      balance_remaining: balance,\r\n      gross_total: grossTotal,\r\n      status: nextStatus,\r\n      updated_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"id\", invoiceId);\r\n\r\n  if (upErr) throw new Error(upErr.message);\r\n\r\n  return {\r\n    invoiceId: Number(inv?.id),\r\n    paid: +paid.toFixed(2),\r\n    balance: +balance.toFixed(2),\r\n    status: nextStatus,\r\n    grossTotal: +grossTotal.toFixed(2),\r\n    totalAmount: +totalAmount.toFixed(2),\r\n    previousBalance: +previousBalance.toFixed(2),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/app/api/products/list/route.ts"],"sourcesContent":["// app/api/products/list/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { getUserFromHeader } from \"@/lib/payments\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n\r\n  return createClient(url, service || anon!, { auth: { persistSession: false } });\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    const user = getUserFromHeader(req.headers.get(\"x-rp-user\"));\r\n    if (!user) {\r\n      return NextResponse.json({ ok: false, error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const supabase = supaAdmin();\r\n\r\n    const activeOnly = (req.nextUrl.searchParams.get(\"activeOnly\") || \"1\") === \"1\";\r\n    const limit = Math.min(Math.max(Number(req.nextUrl.searchParams.get(\"limit\") || 5000), 1), 5000);\r\n\r\n    let q = supabase\r\n      .from(\"products\")\r\n      .select(\r\n        `\r\n        id,\r\n        item_code,\r\n        sku,\r\n        name,\r\n        description,\r\n        units_per_box,\r\n        selling_price,\r\n        is_active,\r\n        image_url\r\n        `\r\n      )\r\n      .order(\"item_code\", { ascending: true })\r\n      .order(\"name\", { ascending: true })\r\n      .limit(limit);\r\n\r\n    if (activeOnly) q = q.eq(\"is_active\", true);\r\n\r\n    const { data, error } = await q;\r\n    if (error) {\r\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\r\n    }\r\n\r\n    // ðŸ”‘ Normalize for invoice UI\r\n    const products = (data || []).map((p: any) => ({\r\n      ...p,\r\n      price_excl_vat: Number(p.selling_price) || 0, // ðŸ‘ˆ critical fix\r\n      vat_rate: 15, // fixed VAT rate\r\n    }));\r\n\r\n    return NextResponse.json({ ok: true, products });\r\n  } catch (e: any) {\r\n    return NextResponse.json(\r\n      { ok: false, error: e?.message || \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA,iCAAiC;AACjC;AACA;AACA;;;;AAEA,SAAS;IACP,MAAM;IACN,MAAM;IACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;IAErD;;IAMA,OAAO,IAAA,gMAAY,EAAC,KAAK,WAAW,MAAO;QAAE,MAAM;YAAE,gBAAgB;QAAM;IAAE;AAC/E;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,OAAO,IAAA,6IAAiB,EAAC,IAAI,OAAO,CAAC,GAAG,CAAC;QAC/C,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,MAAM,WAAW;QAEjB,MAAM,aAAa,CAAC,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,iBAAiB,GAAG,MAAM;QAC3E,MAAM,QAAQ,KAAK,GAAG,CAAC,KAAK,GAAG,CAAC,OAAO,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,OAAO,IAAI;QAE3F,IAAI,IAAI,SACL,IAAI,CAAC,YACL,MAAM,CACL,CAAC;;;;;;;;;;QAUD,CAAC,EAEF,KAAK,CAAC,aAAa;YAAE,WAAW;QAAK,GACrC,KAAK,CAAC,QAAQ;YAAE,WAAW;QAAK,GAChC,KAAK,CAAC;QAET,IAAI,YAAY,IAAI,EAAE,EAAE,CAAC,aAAa;QAEtC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAC9B,IAAI,OAAO;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,8BAA8B;QAC9B,MAAM,WAAW,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC,IAAW,CAAC;gBAC7C,GAAG,CAAC;gBACJ,gBAAgB,OAAO,EAAE,aAAa,KAAK;gBAC3C,UAAU;YACZ,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAS;IAChD,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAe,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}