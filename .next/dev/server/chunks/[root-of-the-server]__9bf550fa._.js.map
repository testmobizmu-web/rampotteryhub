{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/src/lib/payments.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n  return createClient(url, service || anon!);\r\n}\r\n\r\nexport function getUserFromHeader(xRpUser: string | null): any | null {\r\n  if (!xRpUser) return null;\r\n  try {\r\n    return JSON.parse(xRpUser);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function canRecordPayments(user: any) {\r\n  if (!user) return false;\r\n  if (String(user.role || \"\").toLowerCase() === \"admin\") return true;\r\n  // allow accounting / sales to record payments if you have permissions object\r\n  return Boolean(user?.permissions?.canEditInvoices || user?.permissions?.canEditPayments);\r\n}\r\n\r\nexport function canDeletePayments(user: any) {\r\n  if (!user) return false;\r\n  return String(user.role || \"\").toLowerCase() === \"admin\";\r\n}\r\n\r\nfunction n2(v: any) {\r\n  const x = Number(v ?? 0);\r\n  return Number.isFinite(x) ? x : 0;\r\n}\r\n\r\nfunction statusFromPaid(totalDue: number, paid: number, currentStatus: string) {\r\n  const cur = String(currentStatus || \"\").toUpperCase().trim();\r\n  if (cur === \"VOID\") return \"VOID\";\r\n\r\n  const due = Math.max(0, totalDue);\r\n  const p = Math.max(0, paid);\r\n\r\n  if (p <= 0) return \"ISSUED\";\r\n  if (p + 0.00001 >= due) return \"PAID\";\r\n  return \"PARTIALLY_PAID\";\r\n}\r\n\r\n/**\r\n * Recalculate and persist invoice payment state:\r\n * - amount_paid\r\n * - balance_due\r\n * - balance_remaining\r\n * - gross_total\r\n * - status (ISSUED / PARTIALLY_PAID / PAID) unless VOID\r\n *\r\n * Uses:\r\n * - invoices.gross_total if present,\r\n * - else total_amount + previous_balance\r\n */\r\nexport async function recalcInvoicePaymentState(invoiceId: number | string) {\r\n  const supabase = supaAdmin();\r\n\r\n  // 1) get invoice totals + current status\r\n  const { data: inv, error: invErr } = await supabase\r\n    .from(\"invoices\")\r\n    .select(\"id,status,total_amount,previous_balance,gross_total\")\r\n    .eq(\"id\", invoiceId)\r\n    .single();\r\n\r\n  if (invErr) throw new Error(invErr.message);\r\n\r\n  const currentStatus = String(inv?.status || \"\").toUpperCase().trim();\r\n\r\n  const totalAmount = n2(inv?.total_amount);\r\n  const previousBalance = n2(inv?.previous_balance);\r\n\r\n  // Prefer stored gross_total, else compute\r\n  const grossTotal =\r\n    inv?.gross_total != null ? n2(inv.gross_total) : totalAmount + previousBalance;\r\n\r\n  // 2) sum payments\r\n  const { data: pays, error: payErr } = await supabase\r\n    .from(\"invoice_payments\")\r\n    .select(\"amount\")\r\n    .eq(\"invoice_id\", invoiceId);\r\n\r\n  if (payErr) throw new Error(payErr.message);\r\n\r\n  const paid = (pays || []).reduce((sum: number, p: any) => sum + n2(p.amount), 0);\r\n\r\n  const balance = Math.max(0, grossTotal - paid);\r\n\r\n  // 3) compute next status\r\n  const nextStatus = statusFromPaid(grossTotal, paid, currentStatus);\r\n\r\n  // 4) update invoice\r\n  const { error: upErr } = await supabase\r\n    .from(\"invoices\")\r\n    .update({\r\n      amount_paid: paid,\r\n      balance_due: balance,\r\n      balance_remaining: balance,\r\n      gross_total: grossTotal,\r\n      status: nextStatus,\r\n      updated_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"id\", invoiceId);\r\n\r\n  if (upErr) throw new Error(upErr.message);\r\n\r\n  return {\r\n    invoiceId: Number(inv?.id),\r\n    paid: +paid.toFixed(2),\r\n    balance: +balance.toFixed(2),\r\n    status: nextStatus,\r\n    grossTotal: +grossTotal.toFixed(2),\r\n    totalAmount: +totalAmount.toFixed(2),\r\n    previousBalance: +previousBalance.toFixed(2),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/app/api/reports/sales-6m/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { getUserFromHeader } from \"@/lib/payments\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n\r\n  return createClient(url, service || anon!, { auth: { persistSession: false } });\r\n}\r\n\r\nfunction ymKey(d: Date) {\r\n  const y = d.getFullYear();\r\n  const m = String(d.getMonth() + 1).padStart(2, \"0\");\r\n  return `${y}-${m}`;\r\n}\r\n\r\nfunction addMonths(date: Date, months: number) {\r\n  return new Date(date.getFullYear(), date.getMonth() + months, 1);\r\n}\r\n\r\nfunction startOfMonth(d: Date) {\r\n  return new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0, 0);\r\n}\r\n\r\nfunction endOfDay(d: Date) {\r\n  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);\r\n}\r\n\r\nfunction labelForYM(ym: string) {\r\n  const [y, m] = ym.split(\"-\").map((x) => Number(x));\r\n  const d = new Date(y, (m || 1) - 1, 1);\r\n  const mon = d.toLocaleString(\"en-GB\", { month: \"short\" });\r\n  return `${mon} ${String(y).slice(-2)}`;\r\n}\r\n\r\nfunction normStatus(s: any) {\r\n  return String(s || \"\").toLowerCase().trim();\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    const user = getUserFromHeader(req.headers.get(\"x-rp-user\"));\r\n    if (!user) return NextResponse.json({ ok: false, error: \"Unauthorized\" }, { status: 401 });\r\n\r\n    const supabase = supaAdmin();\r\n\r\n    // Last 6 months window: from start of (currentMonth - 5) to end of today\r\n    const now = new Date();\r\n    const fromMonth = addMonths(startOfMonth(now), -5);\r\n    const fromISO = fromMonth.toISOString();\r\n    const toISO = endOfDay(now).toISOString();\r\n\r\n    // Fetch invoices (keep this aligned with your schema)\r\n    // Common fields in your project: invoice_date, total_amount, status\r\n    const { data, error } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"invoice_date, total_amount, status\")\r\n      .gte(\"invoice_date\", fromISO)\r\n      .lte(\"invoice_date\", toISO);\r\n\r\n    if (error) {\r\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\r\n    }\r\n\r\n    // Prepare month buckets in correct order (6 months)\r\n    const months: string[] = [];\r\n    for (let i = 0; i < 6; i++) {\r\n      const d = addMonths(fromMonth, i);\r\n      months.push(ymKey(d));\r\n    }\r\n\r\n    const sums = new Map<string, number>();\r\n    for (const ym of months) sums.set(ym, 0);\r\n\r\n    // Aggregate\r\n    for (const inv of data || []) {\r\n      const st = normStatus(inv.status);\r\n      // Exclude void/cancel (executive chart should reflect real sales)\r\n      if (st.includes(\"void\") || st.includes(\"cancel\")) continue;\r\n\r\n      const dt = inv.invoice_date ? new Date(inv.invoice_date) : null;\r\n      if (!dt || isNaN(dt.getTime())) continue;\r\n\r\n      const ym = ymKey(dt);\r\n      if (!sums.has(ym)) continue;\r\n\r\n      const amt = Number(inv.total_amount || 0);\r\n      sums.set(ym, (sums.get(ym) || 0) + (Number.isFinite(amt) ? amt : 0));\r\n    }\r\n\r\n    const series = months.map((ym) => ({\r\n      ym,\r\n      label: labelForYM(ym),\r\n      total: Number((sums.get(ym) || 0).toFixed(2)),\r\n    }));\r\n\r\n    return NextResponse.json({ ok: true, series });\r\n  } catch (e: any) {\r\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}