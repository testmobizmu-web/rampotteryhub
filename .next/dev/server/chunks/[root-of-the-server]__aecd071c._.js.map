{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/src/lib/supabaseAdmin.ts"],"sourcesContent":["// lib/supabaseAdmin.ts\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!url || !service) {\r\n  throw new Error(\"Missing env: NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\r\n}\r\n\r\nexport const supabaseAdmin = createClient(url, service, {\r\n  auth: { persistSession: false },\r\n});\r\n"],"names":[],"mappings":";;;;AAAA,uBAAuB;AACvB;;AAEA,MAAM;AACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;AAErD,IAAI,CAAC,OAAO,CAAC,SAAS;IACpB,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,KAAK,SAAS;IACtD,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/app/api/dashboard/summary/route.ts"],"sourcesContent":["// app/api/dashboard/summary/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nfunction toNum(v: any) {\r\n  const n = Number(v);\r\n  return Number.isFinite(n) ? n : 0;\r\n}\r\n\r\nexport async function GET(_req: NextRequest) {\r\n  try {\r\n    const today = new Date();\r\n    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\r\n\r\n    // invoice_date is stored as YYYY-MM-DD\r\n    const todayStr = today.toISOString().slice(0, 10);\r\n    const monthStartStr = startOfMonth.toISOString().slice(0, 10);\r\n\r\n    const [todaySalesRes, monthSalesRes, outstandingRes, productsRes, recentInvoicesRes] =\r\n      await Promise.all([\r\n        // 1) TOTAL SALES TODAY\r\n        supabaseAdmin.from(\"invoices\").select(\"total_amount\").eq(\"invoice_date\", todayStr),\r\n\r\n        // 2) TOTAL SALES THIS MONTH\r\n        supabaseAdmin\r\n          .from(\"invoices\")\r\n          .select(\"total_amount\")\r\n          .gte(\"invoice_date\", monthStartStr)\r\n          .lte(\"invoice_date\", todayStr),\r\n\r\n        // 3) OUTSTANDING BALANCE\r\n        supabaseAdmin.from(\"invoices\").select(\"balance_remaining\"),\r\n\r\n        // 4) LOW STOCK (âœ… removed uom)\r\n        supabaseAdmin\r\n          .from(\"products\")\r\n          .select(\"id, sku, name, current_stock, reorder_level\")\r\n          .limit(2000),\r\n\r\n        // 5) RECENT INVOICES\r\n        supabaseAdmin\r\n          .from(\"invoices\")\r\n          .select(\r\n            `\r\n              id,\r\n              invoice_number,\r\n              invoice_date,\r\n              total_amount,\r\n              status,\r\n              customers ( name )\r\n            `\r\n          )\r\n          .order(\"invoice_date\", { ascending: false })\r\n          .limit(10),\r\n      ]);\r\n\r\n    if (todaySalesRes.error) throw new Error(`today sales: ${todaySalesRes.error.message}`);\r\n    if (monthSalesRes.error) throw new Error(`month sales: ${monthSalesRes.error.message}`);\r\n    if (outstandingRes.error) throw new Error(`outstanding: ${outstandingRes.error.message}`);\r\n    if (productsRes.error) throw new Error(`products: ${productsRes.error.message}`);\r\n    if (recentInvoicesRes.error) throw new Error(`recent invoices: ${recentInvoicesRes.error.message}`);\r\n\r\n    const totalSalesToday =\r\n      (todaySalesRes.data || []).reduce((sum: number, r: any) => sum + toNum(r.total_amount), 0) || 0;\r\n\r\n    const totalSalesMonth =\r\n      (monthSalesRes.data || []).reduce((sum: number, r: any) => sum + toNum(r.total_amount), 0) || 0;\r\n\r\n    const outstanding =\r\n      (outstandingRes.data || []).reduce((sum: number, r: any) => sum + toNum(r.balance_remaining), 0) || 0;\r\n\r\n    const lowStock = (productsRes.data || [])\r\n      .map((p: any) => {\r\n        const current = toNum(p.current_stock);\r\n        const reorder = p.reorder_level === null || p.reorder_level === undefined ? null : toNum(p.reorder_level);\r\n\r\n        return {\r\n          id: p.id,\r\n          item_code: p.sku || null,\r\n          name: p.name || null,\r\n          qty: current,\r\n          min_qty: reorder,\r\n        };\r\n      })\r\n      .filter((p: any) => p.min_qty !== null && p.min_qty > 0 && p.qty <= p.min_qty)\r\n      .sort((a: any, b: any) => a.qty - b.qty)\r\n      .slice(0, 10);\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      totalSalesToday,\r\n      totalSalesMonth,\r\n      outstanding,\r\n      lowStock,\r\n      recentInvoices: recentInvoicesRes.data || [],\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"dashboard/summary error:\", err);\r\n    return NextResponse.json(\r\n      { ok: false, error: err?.message || \"Failed to load dashboard\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}