{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/src/lib/payments.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n  return createClient(url, service || anon!);\r\n}\r\n\r\nexport function getUserFromHeader(xRpUser: string | null): any | null {\r\n  if (!xRpUser) return null;\r\n  try {\r\n    return JSON.parse(xRpUser);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function canRecordPayments(user: any) {\r\n  if (!user) return false;\r\n  if (String(user.role || \"\").toLowerCase() === \"admin\") return true;\r\n  // allow accounting / sales to record payments if you have permissions object\r\n  return Boolean(user?.permissions?.canEditInvoices || user?.permissions?.canEditPayments);\r\n}\r\n\r\nexport function canDeletePayments(user: any) {\r\n  if (!user) return false;\r\n  return String(user.role || \"\").toLowerCase() === \"admin\";\r\n}\r\n\r\nfunction n2(v: any) {\r\n  const x = Number(v ?? 0);\r\n  return Number.isFinite(x) ? x : 0;\r\n}\r\n\r\nfunction statusFromPaid(totalDue: number, paid: number, currentStatus: string) {\r\n  const cur = String(currentStatus || \"\").toUpperCase().trim();\r\n  if (cur === \"VOID\") return \"VOID\";\r\n\r\n  const due = Math.max(0, totalDue);\r\n  const p = Math.max(0, paid);\r\n\r\n  if (p <= 0) return \"ISSUED\";\r\n  if (p + 0.00001 >= due) return \"PAID\";\r\n  return \"PARTIALLY_PAID\";\r\n}\r\n\r\n/**\r\n * Recalculate and persist invoice payment state:\r\n * - amount_paid\r\n * - balance_due\r\n * - balance_remaining\r\n * - gross_total\r\n * - status (ISSUED / PARTIALLY_PAID / PAID) unless VOID\r\n *\r\n * Uses:\r\n * - invoices.gross_total if present,\r\n * - else total_amount + previous_balance\r\n */\r\nexport async function recalcInvoicePaymentState(invoiceId: number | string) {\r\n  const supabase = supaAdmin();\r\n\r\n  // 1) get invoice totals + current status\r\n  const { data: inv, error: invErr } = await supabase\r\n    .from(\"invoices\")\r\n    .select(\"id,status,total_amount,previous_balance,gross_total\")\r\n    .eq(\"id\", invoiceId)\r\n    .single();\r\n\r\n  if (invErr) throw new Error(invErr.message);\r\n\r\n  const currentStatus = String(inv?.status || \"\").toUpperCase().trim();\r\n\r\n  const totalAmount = n2(inv?.total_amount);\r\n  const previousBalance = n2(inv?.previous_balance);\r\n\r\n  // Prefer stored gross_total, else compute\r\n  const grossTotal =\r\n    inv?.gross_total != null ? n2(inv.gross_total) : totalAmount + previousBalance;\r\n\r\n  // 2) sum payments\r\n  const { data: pays, error: payErr } = await supabase\r\n    .from(\"invoice_payments\")\r\n    .select(\"amount\")\r\n    .eq(\"invoice_id\", invoiceId);\r\n\r\n  if (payErr) throw new Error(payErr.message);\r\n\r\n  const paid = (pays || []).reduce((sum: number, p: any) => sum + n2(p.amount), 0);\r\n\r\n  const balance = Math.max(0, grossTotal - paid);\r\n\r\n  // 3) compute next status\r\n  const nextStatus = statusFromPaid(grossTotal, paid, currentStatus);\r\n\r\n  // 4) update invoice\r\n  const { error: upErr } = await supabase\r\n    .from(\"invoices\")\r\n    .update({\r\n      amount_paid: paid,\r\n      balance_due: balance,\r\n      balance_remaining: balance,\r\n      gross_total: grossTotal,\r\n      status: nextStatus,\r\n      updated_at: new Date().toISOString(),\r\n    })\r\n    .eq(\"id\", invoiceId);\r\n\r\n  if (upErr) throw new Error(upErr.message);\r\n\r\n  return {\r\n    invoiceId: Number(inv?.id),\r\n    paid: +paid.toFixed(2),\r\n    balance: +balance.toFixed(2),\r\n    status: nextStatus,\r\n    grossTotal: +grossTotal.toFixed(2),\r\n    totalAmount: +totalAmount.toFixed(2),\r\n    previousBalance: +previousBalance.toFixed(2),\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,SAAS;IACP,MAAM;IACN,MAAM;IACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;IAErD;;IAKA,OAAO,IAAA,gMAAY,EAAC,KAAK,WAAW;AACtC;AAEO,SAAS,kBAAkB,OAAsB;IACtD,IAAI,CAAC,SAAS,OAAO;IACrB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,kBAAkB,IAAS;IACzC,IAAI,CAAC,MAAM,OAAO;IAClB,IAAI,OAAO,KAAK,IAAI,IAAI,IAAI,WAAW,OAAO,SAAS,OAAO;IAC9D,6EAA6E;IAC7E,OAAO,QAAQ,MAAM,aAAa,mBAAmB,MAAM,aAAa;AAC1E;AAEO,SAAS,kBAAkB,IAAS;IACzC,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO,OAAO,KAAK,IAAI,IAAI,IAAI,WAAW,OAAO;AACnD;AAEA,SAAS,GAAG,CAAM;IAChB,MAAM,IAAI,OAAO,KAAK;IACtB,OAAO,OAAO,QAAQ,CAAC,KAAK,IAAI;AAClC;AAEA,SAAS,eAAe,QAAgB,EAAE,IAAY,EAAE,aAAqB;IAC3E,MAAM,MAAM,OAAO,iBAAiB,IAAI,WAAW,GAAG,IAAI;IAC1D,IAAI,QAAQ,QAAQ,OAAO;IAE3B,MAAM,MAAM,KAAK,GAAG,CAAC,GAAG;IACxB,MAAM,IAAI,KAAK,GAAG,CAAC,GAAG;IAEtB,IAAI,KAAK,GAAG,OAAO;IACnB,IAAI,IAAI,WAAW,KAAK,OAAO;IAC/B,OAAO;AACT;AAcO,eAAe,0BAA0B,SAA0B;IACxE,MAAM,WAAW;IAEjB,yCAAyC;IACzC,MAAM,EAAE,MAAM,GAAG,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,YACL,MAAM,CAAC,uDACP,EAAE,CAAC,MAAM,WACT,MAAM;IAET,IAAI,QAAQ,MAAM,IAAI,MAAM,OAAO,OAAO;IAE1C,MAAM,gBAAgB,OAAO,KAAK,UAAU,IAAI,WAAW,GAAG,IAAI;IAElE,MAAM,cAAc,GAAG,KAAK;IAC5B,MAAM,kBAAkB,GAAG,KAAK;IAEhC,0CAA0C;IAC1C,MAAM,aACJ,KAAK,eAAe,OAAO,GAAG,IAAI,WAAW,IAAI,cAAc;IAEjE,kBAAkB;IAClB,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,SACzC,IAAI,CAAC,oBACL,MAAM,CAAC,UACP,EAAE,CAAC,cAAc;IAEpB,IAAI,QAAQ,MAAM,IAAI,MAAM,OAAO,OAAO;IAE1C,MAAM,OAAO,CAAC,QAAQ,EAAE,EAAE,MAAM,CAAC,CAAC,KAAa,IAAW,MAAM,GAAG,EAAE,MAAM,GAAG;IAE9E,MAAM,UAAU,KAAK,GAAG,CAAC,GAAG,aAAa;IAEzC,yBAAyB;IACzB,MAAM,aAAa,eAAe,YAAY,MAAM;IAEpD,oBAAoB;IACpB,MAAM,EAAE,OAAO,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,YACL,MAAM,CAAC;QACN,aAAa;QACb,aAAa;QACb,mBAAmB;QACnB,aAAa;QACb,QAAQ;QACR,YAAY,IAAI,OAAO,WAAW;IACpC,GACC,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO,MAAM,IAAI,MAAM,MAAM,OAAO;IAExC,OAAO;QACL,WAAW,OAAO,KAAK;QACvB,MAAM,CAAC,KAAK,OAAO,CAAC;QACpB,SAAS,CAAC,QAAQ,OAAO,CAAC;QAC1B,QAAQ;QACR,YAAY,CAAC,WAAW,OAAO,CAAC;QAChC,aAAa,CAAC,YAAY,OAAO,CAAC;QAClC,iBAAiB,CAAC,gBAAgB,OAAO,CAAC;IAC5C;AACF"}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/app/api/invoices/set-paid/route.ts"],"sourcesContent":["// app/api/invoices/set-paid/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { getUserFromHeader } from \"@/lib/payments\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/* ---------- supabase ---------- */\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n  if (!url || !(service || anon)) {\r\n    throw new Error(\r\n      \"Missing Supabase env. Need NEXT_PUBLIC_SUPABASE_URL + (SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY)\"\r\n    );\r\n  }\r\n  return createClient(url, service || anon!, { auth: { persistSession: false } });\r\n}\r\n\r\nfunction n2(v: any) {\r\n  const x = Number(v ?? 0);\r\n  return Number.isFinite(x) ? x : 0;\r\n}\r\n\r\n/* ---------- whatsapp helpers ---------- */\r\n// digits only, Mauritius default +230\r\nfunction normalizeMuPhone(phone: any) {\r\n  const digits = String(phone || \"\").replace(/[^\\d]/g, \"\");\r\n  if (!digits) return \"\";\r\n\r\n  // local 8-digit number => add 230\r\n  if (digits.length === 8) return \"230\" + digits;\r\n\r\n  // already has 230 + 8 digits (11 total)\r\n  if (digits.startsWith(\"230\") && digits.length === 11) return digits;\r\n\r\n  // if someone stored +23057788884 -> becomes 23057788884 (ok)\r\n  if (digits.startsWith(\"230\") && digits.length >= 11) return digits;\r\n\r\n  // otherwise reject (keeps your requirement: \"230 only\")\r\n  return \"\";\r\n}\r\n\r\nfunction money(v: any) {\r\n  const x = n2(v);\r\n  return new Intl.NumberFormat(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(x);\r\n}\r\n\r\nfunction formatDDMMYYYY(v: any) {\r\n  const s = String(v || \"\").trim();\r\n  const m = s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\r\n  if (m) return `${m[3]}/${m[2]}/${m[1]}`;\r\n  return s;\r\n}\r\n\r\n/**\r\n * Sends a TEMPLATE message (safe outside 24h window).\r\n * You must create template name \"invoice_payment_update\" in WhatsApp Manager.\r\n *\r\n * Template variables:\r\n * 1 invoiceNo\r\n * 2 date\r\n * 3 status\r\n * 4 amountPaid\r\n * 5 balanceRemaining\r\n */\r\nasync function sendWhatsAppPaymentUpdate(opts: {\r\n  to: string; // digits only, includes 230...\r\n  invoiceNo: string;\r\n  invoiceDate: string;\r\n  status: \"PAID ✅\" | \"PARTIALLY PAID ✅\";\r\n  amountPaid: number;\r\n  balanceRemaining: number;\r\n}) {\r\n  const token = process.env.WHATSAPP_TOKEN;\r\n  const phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;\r\n  const apiVersion = process.env.WHATSAPP_API_VERSION || \"v21.0\";\r\n\r\n  if (!token || !phoneNumberId) {\r\n    throw new Error(\"Missing WhatsApp env: WHATSAPP_TOKEN / WHATSAPP_PHONE_NUMBER_ID\");\r\n  }\r\n\r\n  const url = `https://graph.facebook.com/${apiVersion}/${phoneNumberId}/messages`;\r\n\r\n  const payload = {\r\n    messaging_product: \"whatsapp\",\r\n    to: opts.to,\r\n    type: \"template\",\r\n    template: {\r\n      name: \"invoice_payment_update\",\r\n      language: { code: \"en_US\" },\r\n      components: [\r\n        {\r\n          type: \"body\",\r\n          parameters: [\r\n            { type: \"text\", text: opts.invoiceNo },\r\n            { type: \"text\", text: opts.invoiceDate },\r\n            { type: \"text\", text: opts.status },\r\n            { type: \"text\", text: `Rs ${money(opts.amountPaid)}` },\r\n            { type: \"text\", text: `Rs ${money(opts.balanceRemaining)}` },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  };\r\n\r\n  const res = await fetch(url, {\r\n    method: \"POST\",\r\n    headers: {\r\n      Authorization: `Bearer ${token}`,\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n    body: JSON.stringify(payload),\r\n  });\r\n\r\n  const json = await res.json().catch(() => ({}));\r\n  if (!res.ok) {\r\n    const msg = json?.error?.message || \"WhatsApp send failed\";\r\n    throw new Error(msg);\r\n  }\r\n\r\n  return json;\r\n}\r\n\r\n/* ---------- route ---------- */\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const user = getUserFromHeader(req.headers.get(\"x-rp-user\"));\r\n    if (!user) return NextResponse.json({ ok: false, error: \"Unauthorized\" }, { status: 401 });\r\n\r\n    const body: any = await req.json().catch(() => ({}));\r\n    const invoiceId = body.invoiceId ?? body.id;\r\n    const paidNow = n2(body.amountPaid ?? body.amount_paid ?? body.paid ?? 0);\r\n\r\n    if (!invoiceId) {\r\n      return NextResponse.json({ ok: false, error: \"Missing invoiceId\" }, { status: 400 });\r\n    }\r\n    if (paidNow < 0) {\r\n      return NextResponse.json({ ok: false, error: \"amountPaid must be >= 0\" }, { status: 400 });\r\n    }\r\n\r\n    const supabase = supaAdmin();\r\n\r\n    // 1) Read invoice + customer fields we need\r\n    const { data: inv, error: invErr } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"id, invoice_number, invoice_date, customer_id, gross_total, amount_paid, balance_remaining\")\r\n      .eq(\"id\", invoiceId)\r\n      .single();\r\n\r\n    if (invErr || !inv) throw invErr || new Error(\"Invoice not found\");\r\n\r\n    const grossTotal = n2(inv.gross_total);\r\n    const prevPaid = n2(inv.amount_paid);\r\n\r\n    // You can decide: replace paid or add paid\r\n    // Here: we REPLACE paid with the new value (common “Set Paid” behavior)\r\n    const nextPaid = paidNow;\r\n\r\n    const nextBalance = Math.max(0, grossTotal - nextPaid);\r\n\r\n    const status = nextBalance <= 0 ? \"PAID ✅\" : nextPaid > 0 ? \"PARTIALLY PAID ✅\" : null;\r\n\r\n    // 2) Update invoice payment fields\r\n    const { error: upErr } = await supabase\r\n      .from(\"invoices\")\r\n      .update({\r\n        amount_paid: nextPaid,\r\n        balance_remaining: nextBalance,\r\n        balance_due: nextBalance,\r\n        status: nextBalance <= 0 ? \"PAID\" : nextPaid > 0 ? \"PARTIALLY_PAID\" : \"ISSUED\",\r\n      })\r\n      .eq(\"id\", invoiceId);\r\n\r\n    if (upErr) throw upErr;\r\n\r\n    // 3) Only send WhatsApp if it transitions into paid/partial, OR payment changed\r\n    const paymentChanged = Math.abs(nextPaid - prevPaid) > 0.0001;\r\n    if (status && paymentChanged) {\r\n      const { data: cust, error: cErr } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id, name, phone, whatsapp\")\r\n        .eq(\"id\", inv.customer_id)\r\n        .single();\r\n\r\n      if (!cErr && cust) {\r\n        const to = normalizeMuPhone(cust.whatsapp || cust.phone);\r\n\r\n        if (to) {\r\n          await sendWhatsAppPaymentUpdate({\r\n            to,\r\n            invoiceNo: String(inv.invoice_number || inv.id),\r\n            invoiceDate: formatDDMMYYYY(inv.invoice_date),\r\n            status,\r\n            amountPaid: nextPaid,\r\n            balanceRemaining: nextBalance,\r\n          });\r\n        }\r\n      }\r\n      // If customer missing WhatsApp, we silently skip (no crash)\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, invoiceId, amountPaid: nextPaid, balanceRemaining: nextBalance });\r\n  } catch (err: any) {\r\n    console.error(\"Set invoice paid error:\", err);\r\n    return NextResponse.json({ ok: false, error: err?.message || \"Failed\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}