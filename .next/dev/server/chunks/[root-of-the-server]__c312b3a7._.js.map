{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/src/lib/passwords.ts"],"sourcesContent":["// lib/passwords.ts\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nconst ROUNDS = 10; // good default for SaaS (fast + secure)\r\n\r\nexport async function hashPassword(plain: string): Promise<string> {\r\n  const p = String(plain || \"\");\r\n  if (p.length < 4) throw new Error(\"Password too short\");\r\n  const salt = await bcrypt.genSalt(ROUNDS);\r\n  return bcrypt.hash(p, salt);\r\n}\r\n\r\nexport async function verifyPassword(plain: string, hash: string): Promise<boolean> {\r\n  const p = String(plain || \"\");\r\n  const h = String(hash || \"\");\r\n  if (!p || !h) return false;\r\n  return bcrypt.compare(p, h);\r\n}\r\n\r\n// Helper: detect bcrypt format ($2a$ / $2b$ / $2y$)\r\nexport function isBcryptHash(v: string | null | undefined): boolean {\r\n  const s = String(v || \"\");\r\n  return /^\\$2[aby]\\$\\d{2}\\$/.test(s);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA,mBAAmB;AACnB;;AAEA,MAAM,SAAS,IAAI,wCAAwC;AAEpD,eAAe,aAAa,KAAa;IAC9C,MAAM,IAAI,OAAO,SAAS;IAC1B,IAAI,EAAE,MAAM,GAAG,GAAG,MAAM,IAAI,MAAM;IAClC,MAAM,OAAO,MAAM,8IAAM,CAAC,OAAO,CAAC;IAClC,OAAO,8IAAM,CAAC,IAAI,CAAC,GAAG;AACxB;AAEO,eAAe,eAAe,KAAa,EAAE,IAAY;IAC9D,MAAM,IAAI,OAAO,SAAS;IAC1B,MAAM,IAAI,OAAO,QAAQ;IACzB,IAAI,CAAC,KAAK,CAAC,GAAG,OAAO;IACrB,OAAO,8IAAM,CAAC,OAAO,CAAC,GAAG;AAC3B;AAGO,SAAS,aAAa,CAA4B;IACvD,MAAM,IAAI,OAAO,KAAK;IACtB,OAAO,qBAAqB,IAAI,CAAC;AACnC"}},
    {"offset": {"line": 84, "column": 0}, "map": {"version":3,"sources":["file:///C:/Dev/rampotteryhub/app/api/auth/login/route.ts"],"sourcesContent":["// app/api/auth/login/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { hashPassword, verifyPassword, isBcryptHash } from \"@/lib/passwords\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nfunction supaAdmin() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n  if (!url) throw new Error(\"Missing env: NEXT_PUBLIC_SUPABASE_URL\");\r\n  if (!service) throw new Error(\"Missing env: SUPABASE_SERVICE_ROLE_KEY\");\r\n  return createClient(url, service, { auth: { persistSession: false } });\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json().catch(() => null);\r\n    const username = String(body?.username || \"\").trim().toLowerCase();\r\n    const password = String(body?.password || \"\");\r\n\r\n    if (!username || !password) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"Username and password are required.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const supabaseAdmin = supaAdmin();\r\n\r\n    const { data: user, error } = await supabaseAdmin\r\n      .from(\"rp_users\")\r\n      .select(\"id, username, password_hash, role, permissions, is_active\")\r\n      .eq(\"username\", username)\r\n      .limit(1)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Supabase login error:\", error);\r\n      return NextResponse.json(\r\n        { ok: false, error: \"Database error during login.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"Invalid username or password.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (user.is_active === false) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"This user has been deactivated.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const stored = String(user.password_hash || \"\");\r\n    let ok = false;\r\n\r\n    if (isBcryptHash(stored)) {\r\n      ok = await verifyPassword(password, stored);\r\n    } else {\r\n      // Legacy plaintext stored in password_hash (your current state)\r\n      ok = stored === password;\r\n\r\n      // âœ… Auto-upgrade to bcrypt after successful login\r\n      if (ok) {\r\n        const newHash = await hashPassword(password);\r\n        const { error: upErr } = await supabaseAdmin\r\n          .from(\"rp_users\")\r\n          .update({ password_hash: newHash })\r\n          .eq(\"id\", user.id);\r\n        if (upErr) console.error(\"Password hash upgrade failed:\", upErr);\r\n      }\r\n    }\r\n\r\n    if (!ok) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"Invalid username or password.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const session = {\r\n      id: user.id,\r\n      username: user.username,\r\n      role: user.role,\r\n      permissions: user.permissions ?? {},\r\n    };\r\n\r\n    const res = NextResponse.json({ ok: true, session });\r\n\r\n    res.cookies.set(\"rp_session\", JSON.stringify(session), {\r\n      httpOnly: true,\r\n      sameSite: \"lax\",\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      path: \"/\",\r\n      maxAge: 60 * 60 * 8,\r\n    });\r\n\r\n    return res;\r\n  } catch (err: any) {\r\n    console.error(\"Unexpected login error:\", err);\r\n    return NextResponse.json(\r\n      { ok: false, error: \"Unexpected server error.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA,8BAA8B;AAC9B;AACA;AACA;;;;AAEO,MAAM,UAAU;AAEvB,SAAS;IACP,MAAM;IACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;IACrD;;IACA,IAAI,CAAC,SAAS,MAAM,IAAI,MAAM;IAC9B,OAAO,IAAA,gMAAY,EAAC,KAAK,SAAS;QAAE,MAAM;YAAE,gBAAgB;QAAM;IAAE;AACtE;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM;QAC1C,MAAM,WAAW,OAAO,MAAM,YAAY,IAAI,IAAI,GAAG,WAAW;QAChE,MAAM,WAAW,OAAO,MAAM,YAAY;QAE1C,IAAI,CAAC,YAAY,CAAC,UAAU;YAC1B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAAsC,GAC1D;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,gBAAgB;QAEtB,MAAM,EAAE,MAAM,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,cACjC,IAAI,CAAC,YACL,MAAM,CAAC,6DACP,EAAE,CAAC,YAAY,UACf,KAAK,CAAC,GACN,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAA+B,GACnD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAAgC,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,KAAK,SAAS,KAAK,OAAO;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAAkC,GACtD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,OAAO,KAAK,aAAa,IAAI;QAC5C,IAAI,KAAK;QAET,IAAI,IAAA,yIAAY,EAAC,SAAS;YACxB,KAAK,MAAM,IAAA,2IAAc,EAAC,UAAU;QACtC,OAAO;YACL,gEAAgE;YAChE,KAAK,WAAW;YAEhB,kDAAkD;YAClD,IAAI,IAAI;gBACN,MAAM,UAAU,MAAM,IAAA,yIAAY,EAAC;gBACnC,MAAM,EAAE,OAAO,KAAK,EAAE,GAAG,MAAM,cAC5B,IAAI,CAAC,YACL,MAAM,CAAC;oBAAE,eAAe;gBAAQ,GAChC,EAAE,CAAC,MAAM,KAAK,EAAE;gBACnB,IAAI,OAAO,QAAQ,KAAK,CAAC,iCAAiC;YAC5D;QACF;QAEA,IAAI,CAAC,IAAI;YACP,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAAgC,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,UAAU;YACd,IAAI,KAAK,EAAE;YACX,UAAU,KAAK,QAAQ;YACvB,MAAM,KAAK,IAAI;YACf,aAAa,KAAK,WAAW,IAAI,CAAC;QACpC;QAEA,MAAM,MAAM,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAQ;QAElD,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc,KAAK,SAAS,CAAC,UAAU;YACrD,UAAU;YACV,UAAU;YACV,QAAQ,oDAAyB;YACjC,MAAM;YACN,QAAQ,KAAK,KAAK;QACpB;QAEA,OAAO;IACT,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO;QAA2B,GAC/C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}